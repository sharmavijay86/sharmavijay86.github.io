<!DOCTYPE html> <html lang=" en "><head> <meta charset="utf-8" /> <title> oauth2-proxy-for-all-k8s-app - Vijay K. </title> <meta http-equip="X-UA-Compatible" content="IE=edge" /> <meta name="viewport" content="width=device-width, initial-scale=1" /> <meta name="description" content="oauth2-proxy-for-all-k8s-app- oauth2-proxy-for-all-k8s-app"> <meta name="keywords" content="oauth2-proxy-for-all-k8s-app, Vijay K., k8s,"/> <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml" /> <meta content="" property="fb:app_id" /> <meta content="Vijay K." property="og:site_name" /> <meta content="oauth2-proxy-for-all-k8s-app" property="og:title" /> <meta content="article" property="og:type" /> <meta content="oauth2-proxy-for-all-k8s-app" property="og:description" /> <meta content="http://0.0.0.0:4000/blog/oauth2-proxy-for-all-k8s-app/" property="og:url" /> <meta content="2023-02-18T07:05:23-06:00" property="article:published_time" /> <meta content="http://0.0.0.0:4000/about/" property="article:author" /> <meta content="http://0.0.0.0:4000/assets/img/posts/kubernetes3.jpg" property="og:image" /> <meta content="k8s" property="article:section" /> <!-- Twitter Cards --> <meta name="twitter:card" content="summary" /> <meta name="twitter:site" content="@" /> <meta name="twitter:creator" content="@" /> <meta name="twitter:title" content="oauth2-proxy-for-all-k8s-app" /> <meta name="twitter:url" content="http://0.0.0.0:4000/blog/oauth2-proxy-for-all-k8s-app/" /> <meta name="twitter:description" content="oauth2-proxy-for-all-k8s-app" /> <link rel="stylesheet" href="http://0.0.0.0:4000/assets/css/main.css" /> <!-- <link rel="stylesheet" href="http://0.0.0.0:4000/assets/css/custom-style.css" /> --> <link rel="stylesheet" href="http://0.0.0.0:4000/assets/bower_components/lightgallery/dist/css/lightgallery.min.css" /> <link rel="stylesheet" href="https://cdn.snipcart.com/themes/v3.0.0-beta.3/default/snipcart.css" /> <link rel="stylesheet" href="http://0.0.0.0:4000/assets/bower_components/bootstrap/dist/css/bootstrap.min.css" /> <link rel="stylesheet" href="http://0.0.0.0:4000/assets/bower_components/font-awesome/web-fonts-with-css/css/fontawesome-all.min.css" /> <link rel="stylesheet" href="http://0.0.0.0:4000/assets/bower_components/icono/dist/icono.min.css" /> <!-- Fonts--> <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet" /> <!-- Favicon --> <link rel="icon" href="http://0.0.0.0:4000/assets/img/favicon.ico" type="image/gif" sizes="16x16" /> <script> var base_url = 'http://0.0.0.0:4000' ; </script> <!-- Jquery --> <script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha384-vk5WoKIaW/vJyUAd9n/wmopsmNhiy+L2Z+SBxGYnUkunIxVxAv/UtMOhba/xskxh" crossorigin="anonymous" ></script> <!-- <script src="http://0.0.0.0:4000/assets/bower_components/jquery/dist/jquery.min.js"></script> --> <script src="http://0.0.0.0:4000/assets/js/mode-switcher.js"></script> <script src="http://0.0.0.0:4000/assets/bower_components/jquery.easing/jquery.easing.min.js"></script> <script src="http://0.0.0.0:4000/assets/bower_components/bootstrap/dist/js/bootstrap.bundle.min.js"></script> <script src="http://0.0.0.0:4000/assets/bower_components/jquery-mousewheel/jquery.mousewheel.min.js"></script> <script src="http://0.0.0.0:4000/assets/bower_components/ghosthunter/dist/jquery.ghostHunter.min.js"></script> <script src="http://0.0.0.0:4000/assets/bower_components/lightgallery/dist/js/lightgallery-all.min.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/picturefill/3.0.2/picturefill.min.js"></script> <script src="http://0.0.0.0:4000/assets/bower_components/imagesloaded/imagesloaded.pkgd.min.js"></script> <script src="http://0.0.0.0:4000/assets/bower_components/nanobar/nanobar.min.js"></script> <script src="http://0.0.0.0:4000/assets/bower_components/typewrite/dist/typewrite.min.js"></script> <script src="http://0.0.0.0:4000/assets/js/search.js"></script> <script src="http://0.0.0.0:4000/assets/js/on-scroll-progress.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.20.1/moment.min.js"></script> <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script> <!-- for Mathjax support --> <script type="text/x-mathjax-config"> MathJax.Hub.Config({ TeX: { equationNumbers: { autoNumber: "AMS" } } }); </script> <script type="text/javascript" async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script> <!-- Github Button --> <script async defer src="https://buttons.github.io/buttons.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous" ></script> <!-- (you can remove the below scripts but do buy me a coffee to show some support :) --> <!-- Maker widget --> <!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]--> <!--[if IE 7]> <html class="no-js lt-ie9 lt-ie8"> <![endif]--> <!--[if IE 8]> <html class="no-js lt-ie9"> <![endif]--> <!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]--> </head> <body> <nav class="navbar navbar-expand-lg fixed-top navbar-dark" id="topNav"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation" > <span class="icono-hamburger" id="navbar-hamburger"> </span> </button> <a class="navbar-brand" href="/">Vijay K.</a> <div class="collapse navbar-collapse" id="navbarNav"> <ul class="navbar-nav"> <li class="nav-item"> <a class="nav-link" href="http://0.0.0.0:4000/" >Home</a > </li> <li class="nav-item"> <a class="nav-link" href="http://0.0.0.0:4000/about" >About me</a > </li> <li class="nav-item"> <a class="nav-link" href="http://0.0.0.0:4000/blog" >Blog</a > </li> <li class="nav-item"> <a class="nav-link" href="http://0.0.0.0:4000/contact" >Contact me</a > </li> </ul> </div> <ul class="nav justify-content-end"> <li class="nav-item"> <a class="nav-link toggle-search-button" href="#search"> <i class="fa fa-search search-icon" aria-hidden="true"></i> </a> </li> <li class="nav-item"> <input class="nav-link switch theme-toggle" type="checkbox" name="checkbox" /> </li> </ul> </nav> <div id="progress-bar"></div> <!-- Search Form --> <div class="search-form-container"> <form class="search-form"> <fieldset class="search-form__fieldset"> <div class="row"> <div class="col-lg-8 offset-md-2"> <input class="search-form__field" placeholder="Type to Search..." autofocus> <input class="search-form__submit" type="submit" value="search"> </div> </div> </fieldset> </form> <div class="row"> <div class="col-lg-8 offset-md-2 search-results"> <div class="card search-results"></div> </div> </div> <div class="close-search-button search-form-container__close"> <i class="fa fa-times icon"></i> </div> </div><div class="main-container"> <div class="row justify-content-center" id="blog-post-container"> <div class="col-lg-10"><article class="card" itemscope itemtype="http://schema.org/BlogPosting"> <div class="card-header"> <h1 class="post-title" itemprop="name headline">oauth2-proxy-for-all-k8s-app</h1> <h4 class="post-meta">oauth2-proxy-for-all-k8s-app</h4> <p class="post-summary"> Posted by : <span itemprop="author" itemscope itemtype="http://schema.org/Person"> <span itemprop="name"><a href="http://0.0.0.0:4000/blog/authors/vijayk">vijayk</a></span> </span > on <time datetime="2023-02-18 07:05:23 -0600" itemprop="datePublished" >Feb 18, 2023</time > </p> <span class="disqus-comment-count" data-disqus-identifier="/blog/oauth2-proxy-for-all-k8s-app/" ></span> <div class="post-categories"> Category : <a href="/blog/categories/k8s" >k8s</a > </div> </div> <div class="card-body" itemprop="articleBody"> <img class="card-img-top" src="http://0.0.0.0:4000/assets/img/posts/kubernetes3.jpg" alt="" /> <br /> <br /> <h1 id="oauth2-proxy-github-auth-integration-for-all-k8s-application">Oauth2-proxy github auth integration for all k8s application.</h1> <p>Kubernetes is a very powerfull and moduler orchestration system. It gives option to modify it completely as per our use cases. One of the use case is setting up authorization mechanisms. We had a requirement in which we wanted to secure most of application which does not have any native authentication system like kibana and kubernetes dashboard. It include some other application also. Mainly flow is like this</p> <ul> <li>User opens dashboard.devk8s.mylab.local ( application )</li> <li>User redirected to login.devk8s.mylab.local for github auth ( my oauth2-proxy url )</li> <li>User logged in with github authentication and presented (redirected) to application now. dashboard.devk8s.mylab.local</li> </ul> <h2 id="requirements">Requirements:</h2> <p>To get this done in my k8s cluster i am going to use oauth2-proxy helm chart, nginx ingress controller and github app.</p> <h3 id="create-github-app">Create github app</h3> <p>Note: to implement RBAC we need github orgnization and teams. i am taking example that i have orgnization name as <strong>MyOrg</strong> and team name is <strong>adminusers</strong></p> <ol> <li>Login to your github.com account. Nevigate to orgnization page. Go to settings –&gt; developer settings –&gt; new oauth app</li> <li>Putt bello entries- Application Name: oauth2proxy Home page url: https://login.devk8s.mylab.local Authorization callback URL: https://login.devk8s.mylab.local/oauth2/callback</li> <li>Take a note of <strong>client ID</strong> and <strong>Client secret</strong>.</li> </ol> <h3 id="deploy-oauth2-proxy-by-using-helm-chart">Deploy oauth2-proxy by using helm chart</h3> <ol> <li>Bellow is the helm chart values file <script src="https://gist.github.com/sharmavijay86/1fa19b9775462e1794c48b9b3feb8c49.js"></script></li> <li>Make neccessory modifications</li> <li>add helm repo</li> </ol> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>helm repo add k8s-at-home https://k8s-at-home.com/charts/
helm repo update
</code></pre></div></div> <p>Now you have already downloaded and created values.yaml file from above gist. Lets use it and deploy the helm chart.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>helm install oauth2-proxy k8s-at-home/oauth2-proxy --namespace=auth-system --create-namespaces=true --values=values.yaml
</code></pre></div></div> <p>Done!</p> <h3 id="deploy-hello-world-app">deploy hello world app</h3> <p>Bellow is the example manifest of hello k8s application. modify ingress host urls. Take a note here i am adding bellow annotations to work with oauth2.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nginx.ingress.kubernetes.io/auth-response-headers: X-Auth-Request-User,X-Auth-Request-Email
nginx.ingress.kubernetes.io/auth-signin: https://login.devk8s.mylab.local/oauth2/start
nginx.ingress.kubernetes.io/auth-url: https://login.devk8s.mylab.local/oauth2/auth
</code></pre></div></div> <p>Full application manifest-</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># hello-kubernetes.yaml
apiVersion: v1
kind: Service
metadata:
  name: hello-kubernetes
spec:
  ports:
  - port: 80
    targetPort: 8080
  selector:
    app: hello-kubernetes
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: hello-kubernetes
spec:
  replicas: 1
  selector:
    matchLabels:
      app: hello-kubernetes
  template:
    metadata:
      labels:
        app: hello-kubernetes
    spec:
      containers:
      - name: hello-kubernetes
        image: sharmavijay86/hello-k8s:v1
        ports:
        - containerPort: 8080
        env:
          - name: MESSAGE
            value: Hello from git 
---
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
    annotations:
      kubernetes.io/ingress.class: nginx
      cert-manager.io/issuer: mylab
      nginx.ingress.kubernetes.io/auth-response-headers: X-Auth-Request-User,X-Auth-Request-Email
      nginx.ingress.kubernetes.io/auth-signin: https://login.devk8s.mylab.local/oauth2/start
      nginx.ingress.kubernetes.io/auth-url: https://login.devk8s.mylab.local/oauth2/auth
    name: nginx-test
spec:
    rules:
      - host: hello.devk8s.mylab.local
        http:
          paths:
            - backend:
                serviceName: hello-kubernetes
                servicePort: 80
              path: /
    tls:
    - hosts:
       - hello.devk8s.mylab.local
      secretName: hello-tls
</code></pre></div></div> <p>Now when i am trying to open hello.devk8s.mylab.local url it presents me github auth and after login only i am getting access of hello k8s application. For same results with other applications like kibana or kubernetes dashboard, just add the three annotations as described above. done!</p> <br /><!-- Load Facebook SDK for JavaScript --> <div id="fb-root"></div> <script> (function(d, s, id) { var js, fjs = d.getElementsByTagName(s)[0]; if (d.getElementById(id)) return; js = d.createElement(s); js.id = id; js.src = "https://connect.facebook.net/en_US/sdk.js#xfbml=1&version=v3.0"; fjs.parentNode.insertBefore(js, fjs); })(document, "script", "facebook-jssdk"); </script> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8" ></script> <div class="share-page"> <p class="share-text">Share this on &rarr;</p> <a href="https://twitter.com/share?ref_src=twsrc%5Etfw" class="twitter-share-button" data-size="large" data-show-count="false" style="margin-top:5px;" >Tweet</a > <a class="fb-share-button" data-href="http://0.0.0.0:4000/blog/oauth2-proxy-for-all-k8s-app/" data-size="large" data-layout="button" >Share</a> </div><!-- Author box --> </div><!-- Incomment incase you want to use Disqus <div id="disqus_thread"></div> --> </article> <script> var disqus_config = function () { this.page.url = "http://0.0.0.0:4000/blog/oauth2-proxy-for-all-k8s-app/"; /* Replace PAGE_URL with your page's canonical URL variable */ this.page.identifier = "/blog/oauth2-proxy-for-all-k8s-app"; /* Replace PAGE_IDENTIFIER with your page's unique identifier variable */ }; (function () { /* DON'T EDIT BELOW THIS LINE */ var d = document, s = d.createElement('script'); s.src = 'https://.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); </script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a> </noscript></div> </div> <div class="row"> <div class="col-md-4"> <div class="card"> <div class="card-header">About Vijay K.</div> <div class="card-body"> <p class="author_bio">Hi! My name is Vijay K. I am a consultent, Engineer, Trainer, Architect and your friend. I am DevOps,cloud and Kubernetes Architect and consultant. 17+ Years of IT Experience. Extensive experience in kubernetes, microservices, container and application platform designing and solutioning in GCP and Azure Cloud. Expertise in GCP and Azure pubic cloud platform. Software life cycle management, CI/CD, Infrastructure provisioning experience with code. Automation and scripting of platform and production development.</p><!-- Place this tag where you want the github button to render. --> <a class="github-button" href="https://github.com/mevijays/training-k8s" data-color-scheme="no-preference: dark; light: dark; dark: dark;" data-icon="octicon-star" data-size="large" data-show-count="true" aria-label="Star sujaykundu777/devlopr-jekyll on GitHub">Star</a> </div> </div> </div> <div class="col-md-4"> <div class="card"> <div class="card-header">Categories</div> <div class="card-body text-dark"> <div id="#k8s"></div> <li class="tag-head"> <a href="/blog/categories/k8s">k8s</a> </li> <a name="k8s"></a> </div> </div> </div> <div class="col-md-4"> <div class="card"> <div class="card-header">Useful Links</div> <div class="card-body text-dark"> <li> <a href="http://0.0.0.0:4000/">Home</a> </li> <li> <a href="http://0.0.0.0:4000/about">About me</a> </li> <li> <a href="http://0.0.0.0:4000/blog">Blog</a> </li> <li> <a href="http://0.0.0.0:4000/contact">Contact me</a> </li> </div> </div> </div> </div> </div> <div class="col-lg-12" id="newsletter_footer"><!-- Mailchimp Newletters --> <form action="https://gmail.us10.list-manage.com/subscribe/post?u=ff9e8f3ce82bf1eb36904e570&amp;id=5f324018b2&amp;f_id=007ce8e5f0"method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate> <div id="mc_embed_signup_scroll_footer"> <label for="mce-EMAIL_footer"> Signup if you like to get latest posts mail/</label> <input type="email" value="" name="EMAIL" class="email" id="mce-EMAIL_footer" placeholder="email address" required> <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups--> <div style="position: absolute; left: -5000px;" aria-hidden="true"> <input type="text" name="b_50bab1c85eae24ecfb0f68361_3a2dd721d0" tabindex="-1" value=""> </div><br /> <div class="clear"> <input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe_footer" class="btn btn-lg btn-success"> </div> </div> </div><footer> <p> mevijay.com | mevijay.dev | vijay@mevijay.com </p> </footer> <script> var options = { classname: 'progressline', id: 'my-id' }; var nanobar = new Nanobar( options ); nanobar.go( 30 ); nanobar.go( 76 ); nanobar.go(100); </script> <div hidden id="snipcart" data-api-key="Y2I1NTAyNWYtMTNkMy00ODg0LWE4NDItNTZhYzUxNzJkZTI5NjM3MDI4NTUzNzYyMjQ4NzU0"></div> <script src="https://cdn.snipcart.com/themes/v3.0.0-beta.3/default/snipcart.js" defer></script> <script> if (window.netlifyIdentity) { window.netlifyIdentity.on("init", user => { if (!user) { window.netlifyIdentity.on("login", () => { document.location.href = "/admin/"; }); } }); } </script> </body> </html>
